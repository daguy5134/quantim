{% extends 'base.html' %}
{% block title %} {{ title }} {% endblock %}
{% block header %} {{ title }} {% endblock %}
{% block header_bg_image %} https://ssl.gstatic.com/atari/images/aristotle-header-dark.jpg  {% endblock %}
{% block menu_icon %}<span class="menu_icon" onclick="openNav()">&#9776;</span>{% endblock %}
{% block content %}
<a class="add-dev-button" href="/add_reminder">+</a>
<div  id="loading" style="display: none; text-align: middle;"><div class="lds-ring"><div></div><div></div><div></div><div></div></div> <span>En cours de chargement</span></div>
{% endblock %}
{% block after_content %}{% endblock %}
{% block script %}

    function adjustColorBrightness(color, percent) {
        let num = parseInt(color.slice(1), 16);
        let amt = Math.round(2.55 * percent);
        let r = (num >> 16) + amt;
        let g = (num >> 8 & 0x00FF) + amt;
        let b = (num & 0x0000FF) + amt;
    
        r = Math.max(0, Math.min(255, r));
        g = Math.max(0, Math.min(255, g));
        b = Math.max(0, Math.min(255, b));
    
        return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
    }

    async function loadRessource (ressource_route) {
            const ressource = await fetch(ressource_route);
            const response = await ressource.json();
            return response;
    }
loading.style.display = "none";  
          
async function fetchData () {
    const tagArr = await loadRessource("/api/tag");
    const subjectArr = await loadRessource("/api/subject"); 
    const reminderArr = await loadRessource("/api/reminder");
    const loading = document.getElementById("loading")
    
    if (Array.isArray(reminderArr)) {
        if (reminderArr) {
            loading.style.display = "block";
            const remHTMLcontainers = []; // Array for all reminder Divs before being added
        
            reminderArr.forEach(function(element, index) {
                let reminder = document.createElement("div");
                let subject = subjectArr.find(mySubject => mySubject.id === element.subject_id);
                let tag = tagArr.find(myTag => myTag.id === element.tag_id);
                element.date = new Date(element.date)
                reminder.className = "reminder-container"; // Renamed for clarity
                reminder.style.backgroundColor = subject.bg_color; // Corrected typo
                reminder.id = `remDiv${index}`;
                remHTMLcontainers.push(reminder);
                const elem_attributes = {
                    tagged: {
                        htmlType: "a",
                        elemContent: tag.content,
                        elemBgColor: tag.bg_color
                    },
                    date: {
                        htmlType: "nobr",
                        elemContent: "Pour : " + find_date_name(element.date)
                    },
                    topic: {
                        htmlType: "h2",
                        elemContent: subject.content // Corrected to display subject name
                    },
                    text: {
                        htmlType: "p",
                        elemContent: element.content
                    }
                };
                Object.keys(elem_attributes).forEach(function(attr){
                    let elem = document.createElement(elem_attributes[attr].htmlType);
                    elem.innerHTML = elem_attributes[attr].elemContent;
                    elem.className =  `reminder${elem_attributes[attr].htmlType}`; // Made class more specific
                    elem.id = `rem${elem_attributes[attr].htmlType}${index}`;
                    if (elem_attributes[attr].htmlType === "a") {
                        elem.style.backgroundColor = elem_attributes[attr].elemBgColor;
                    } else if (elem_attributes[attr].htmlType === "h2") {
                        elem.style.color = adjustColorBrightness(subject.bg_color, 70);
                    }
                    reminder.appendChild(elem);
                });
            });
            loading.style.display = "none";
            remHTMLcontainers.forEach(function(div){
                document.getElementById("main").appendChild(div);
            });
    } else {
        console.error("Data fetched is not an array");
    }
}

fetchData();
    
    {% endblock %}
