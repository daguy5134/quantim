{% extends 'base.html' %}
{% block title %} {{ title }} {% endblock %}
{% block header %} {{ title }} {% endblock %}
{% block header_bg_image %} https://ssl.gstatic.com/atari/images/aristotle-header-dark.jpg  {% endblock %}
{% block content %}
<a href="/logout" style="font-size: 100;color:azure; display: block;">log out</a>
{% endblock %}
{% block script %}

    function adjustColorBrightness(color, percent) {
        let num = parseInt(color.slice(1), 16);
        let amt = Math.round(2.55 * percent);
        let r = (num >> 16) + amt;
        let g = (num >> 8 & 0x00FF) + amt;
        let b = (num & 0x0000FF) + amt;
    
        r = Math.max(0, Math.min(255, r));
        g = Math.max(0, Math.min(255, g));
        b = Math.max(0, Math.min(255, b));
    
        return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
    }

    async function loadRessource (ressource_route) {
            const ressource = await fetch(ressource_route);
            const response = await ressource.json();
            return response;
    }
    
    class myReminderClass {
        constructor (content, subject, tag, date) {
            this.content = content;
            this.subject = subject; // Corrected
            this.tag = tag;
            this.date = date;
        }
    }
    class tag {
        constructor (content, bgColor) {
            this.content = content;
            this.bgColor = bgColor;
        }
    }
    class mySubjectClass {
        constructor (name, bgColor) {
            this.name = name;
            this.bgColor = bgColor;
        }
    }
          
async function fetchData () {
    const tagArr = await loadRessource("/api/tag");
    const subjectArr = await loadRessource("/api/subject"); 
    const reminderArr = await loadRessource("/api/reminder");
    
    if (Array.isArray(reminderArr)) {
        const remHTMLcontainers = []; // Array for all reminder Divs before being added
    
        reminderArr.forEach(function(element, index) {
            let reminder = document.createElement("div");
            let subject = subjectArr.find(mySubject => mySubject.id === element.subject_id);
            let tag = tagArr.find(myTag => myTag.id === element.tag_id);
            reminder.className = "reminder-container"; // Renamed for clarity
            reminder.style.backgroundColor = subject.bgColor; // Corrected typo
            reminder.id = `remDiv${index}`;
            remHTMLcontainers.push(reminder);
            const elem_attributes = {
                tagged: {
                    htmlType: "a",
                    elemContent: tag.content,
                    elemBgColor: tag.bgColor
                },
                date: {
                    htmlType: "nobr",
                    elemContent: "For : " + element.date.toLocaleDateString('en-GB')
                },
                topic: {
                    htmlType: "h2",
                    elemContent: subject.content // Corrected to display subject name
                },
                text: {
                    htmlType: "p",
                    elemContent: element.content
                }
            };
            Object.keys(elem_attributes).forEach(function(attr){
                let elem = document.createElement(elem_attributes[attr].htmlType);
                elem.innerHTML = elem_attributes[attr].elemContent;
                elem.className =  `reminder${elem_attributes[attr].htmlType}`; // Made class more specific
                elem.id = `rem${elem_attributes[attr].htmlType}${index}`;
                if (elem_attributes[attr].htmlType === "a") {
                    elem.style.backgroundColor = elem_attributes[attr].elemBgColor;
                } else if (elem_attributes[attr].htmlType === "h2") {
                    elem.style.color = adjustColorBrightness(element.subject.bgColor, 70);
                }
                reminder.appendChild(elem);
            });
        });
        remHTMLcontainers.forEach(function(div){
            document.getElementById("main").appendChild(div);
        });
    } else {
        console.error("Data fetched is not an array");
    }
}

fetchData();
    
    {% endblock %}
